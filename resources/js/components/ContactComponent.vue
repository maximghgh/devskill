<template>
    <div>
        <div class="maincontainer">
            <div class="container">
                <section class="contacts">
                    <div class="contacts__inner">
                        <p class="contacts__name">Контакты</p>
                        <div class="contacts__content">
                            <div class="contacts__block">
                                <div class="contacts__img">
                                    <img src="../../img/technic.png" />
                                </div>
                                <div class="contacts__title">Технический отдел</div>
                                <div class="contacts__desc">
                                    Описание о том, какие вопросы можно задавать
                                </div>
                                <div class="contacts__contact contacts_mail">
                                    <svg width="21" height="17" viewBox="0 0 21 17">
                                        <image
                                            width="21"
                                            height="17"
                                            xlink:href="data:img/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAARCAYAAAAyhueAAAABZElEQVQ4jaWUvU4CQRSFv0UtlMKKQmOo0M5GLLQm9BbGwthY8QZ2hsT4EjYkFJhYGXsSfAREKo2FFpBQUEKMiubCWTLuj7h6mtl75txvM7Oz4zUaT1vABbAJDIAhybUILAH3QMmgz0D2D6A4vaQE/AQKwB7QignHqaW+gjjZlJZsagM3QB44+8U2DJXLq68tf2DQEeABKzLfgTKwC9RDqInqmi8rj/qNM0oF3ozCpjugCBwBfXl91UXNu/npylzoq8YqcAVkVNeAHeBcY01+RrlqoP8b1H/uAgdAEziW9wicakR+U7lukOVCfX1oXAUqwDWQk5dTXdE8Tn6q+RBystmu7LhsA5fAIbA2Ix8JjZKBTiL8SEUt/9+K+lCh5cyQF+gfP3j6vXrykl4ofr4njmd7mlZht1UHWE4Itfy6cxrSBjWQGbcJYb7sj3pw6o5B93WfbgBvumBCZ+8HzekuXRjDofQFpONNGsfTT40AAAAASUVORK5CYII="
                                        />
                                    </svg>
                                    <p>eedu@istu.ru</p>
                                </div>
                                <div class="contacts__contact contacts_phone">
                                    <svg width="13" height="25" viewBox="0 0 13 25">
                                        <image
                                            width="13"
                                            height="25"
                                            xlink:href="data:img/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAZCAYAAADqrKTxAAABFUlEQVQ4je3Uuy5EURTG8d/MnIk7QYHQqfReQK8VtUiUEiqFp1BJxFMoSaaTeAEVInHrKEgQ1yyWMGbcev9kZ2fv9X17rZOctUq12n4PVjCJElpQRqtXznGX93tYKLCGqRRcYCuFm+jDMgYyPo6NME14pzOFkWkIvehST7XIY6TdRVuKBjGHB2zjFo/5yHCRLy9h3c90R/lRxhM6fmGQuqKch3JDuDmVv4jr+Df9m5qbSg2Rbyin4fprSR030VdFtkY1Iy9/ce79uPzwYDRk+0tZtdr+aQ6Nk9yD6JsDjORQCe7zvhKZIkt0b6w3NjCP2RwsH7mKb9ppUvsxDnN95iEyzWA1p1KUEmVMYxRjOEtXlH6ExWeNuDJXtYhfrQAAAABJRU5ErkJggg=="
                                        />
                                    </svg>
                                    <p>8 (3412) 77-60-55, доб. 5160</p>
                                </div>
                            </div>
                            <div class="contacts__block">
                                <div class="contacts__img">
                                    <img src="../../img/organization.png" />
                                </div>
                                <div class="contacts__title">
                                    Организация мероприятий
                                </div>
                                <div class="contacts__desc">
                                    Описание о том, какие вопросы можно задавать
                                </div>
                                <div class="contacts__contact contacts_mail">
                                    <svg width="21" height="17" viewBox="0 0 21 17">
                                        <image
                                            width="21"
                                            height="17"
                                            xlink:href="data:img/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAARCAYAAAAyhueAAAABZElEQVQ4jaWUvU4CQRSFv0UtlMKKQmOo0M5GLLQm9BbGwthY8QZ2hsT4EjYkFJhYGXsSfAREKo2FFpBQUEKMiubCWTLuj7h6mtl75txvM7Oz4zUaT1vABbAJDIAhybUILAH3QMmgz0D2D6A4vaQE/AQKwB7QignHqaW+gjjZlJZsagM3QB44+8U2DJXLq68tf2DQEeABKzLfgTKwC9RDqInqmi8rj/qNM0oF3ozCpjugCBwBfXl91UXNu/npylzoq8YqcAVkVNeAHeBcY01+RrlqoP8b1H/uAgdAEziW9wicakR+U7lukOVCfX1oXAUqwDWQk5dTXdE8Tn6q+RBystmu7LhsA5fAIbA2Ix8JjZKBTiL8SEUt/9+K+lCh5cyQF+gfP3j6vXrykl4ofr4njmd7mlZht1UHWE4Itfy6cxrSBjWQGbcJYb7sj3pw6o5B93WfbgBvumBCZ+8HzekuXRjDofQFpONNGsfTT40AAAAASUVORK5CYII="
                                        />
                                    </svg>
                                    <p>eedu@istu.ru</p>
                                </div>
                                <div class="contacts__contact contacts_phone">
                                    <svg width="13" height="25" viewBox="0 0 13 25">
                                        <image
                                            width="13"
                                            height="25"
                                            xlink:href="data:img/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAZCAYAAADqrKTxAAABFUlEQVQ4je3Uuy5EURTG8d/MnIk7QYHQqfReQK8VtUiUEiqFp1BJxFMoSaaTeAEVInHrKEgQ1yyWMGbcev9kZ2fv9X17rZOctUq12n4PVjCJElpQRqtXznGX93tYKLCGqRRcYCuFm+jDMgYyPo6NME14pzOFkWkIvehST7XIY6TdRVuKBjGHB2zjFo/5yHCRLy9h3c90R/lRxhM6fmGQuqKch3JDuDmVv4jr+Df9m5qbSg2Rbyin4fprSR030VdFtkY1Iy9/ce79uPzwYDRk+0tZtdr+aQ6Nk9yD6JsDjORQCe7zvhKZIkt0b6w3NjCP2RwsH7mKb9ppUvsxDnN95iEyzWA1p1KUEmVMYxRjOEtXlH6ExWeNuDJXtYhfrQAAAABJRU5ErkJggg=="
                                        />
                                    </svg>
                                    <p>8 (3412) 77-60-55, доб. 5160</p>
                                </div>
                            </div>
                            <div class="contacts__block">
                                <div class="contacts__img">
                                    <img src="../../img/general.png" />
                                </div>
                                <div class="contacts__title">Общие вопросы</div>
                                <div class="contacts__desc">
                                    Описание о том, какие вопросы можно задавать
                                </div>
                                <div class="contacts__contact contacts_mail">
                                    <svg width="21" height="17" viewBox="0 0 21 17">
                                        <image
                                            width="21"
                                            height="17"
                                            xlink:href="data:img/png;base64,iVBORw0KGgoAAAANSUhEUgAAABUAAAARCAYAAAAyhueAAAABZElEQVQ4jaWUvU4CQRSFv0UtlMKKQmOo0M5GLLQm9BbGwthY8QZ2hsT4EjYkFJhYGXsSfAREKo2FFpBQUEKMiubCWTLuj7h6mtl75txvM7Oz4zUaT1vABbAJDIAhybUILAH3QMmgz0D2D6A4vaQE/AQKwB7QignHqaW+gjjZlJZsagM3QB44+8U2DJXLq68tf2DQEeABKzLfgTKwC9RDqInqmi8rj/qNM0oF3ozCpjugCBwBfXl91UXNu/npylzoq8YqcAVkVNeAHeBcY01+RrlqoP8b1H/uAgdAEziW9wicakR+U7lukOVCfX1oXAUqwDWQk5dTXdE8Tn6q+RBystmu7LhsA5fAIbA2Ix8JjZKBTiL8SEUt/9+K+lCh5cyQF+gfP3j6vXrykl4ofr4njmd7mlZht1UHWE4Itfy6cxrSBjWQGbcJYb7sj3pw6o5B93WfbgBvumBCZ+8HzekuXRjDofQFpONNGsfTT40AAAAASUVORK5CYII="
                                        />
                                    </svg>
                                    <p>eedu@istu.ru</p>
                                </div>
                                <div class="contacts__contact contacts_phone">
                                    <svg width="13" height="25" viewBox="0 0 13 25">
                                        <image
                                            width="13"
                                            height="25"
                                            xlink:href="data:img/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA0AAAAZCAYAAADqrKTxAAABFUlEQVQ4je3Uuy5EURTG8d/MnIk7QYHQqfReQK8VtUiUEiqFp1BJxFMoSaaTeAEVInHrKEgQ1yyWMGbcev9kZ2fv9X17rZOctUq12n4PVjCJElpQRqtXznGX93tYKLCGqRRcYCuFm+jDMgYyPo6NME14pzOFkWkIvehST7XIY6TdRVuKBjGHB2zjFo/5yHCRLy9h3c90R/lRxhM6fmGQuqKch3JDuDmVv4jr+Df9m5qbSg2Rbyin4fprSR030VdFtkY1Iy9/ce79uPzwYDRk+0tZtdr+aQ6Nk9yD6JsDjORQCe7zvhKZIkt0b6w3NjCP2RwsH7mKb9ppUvsxDnN95iEyzWA1p1KUEmVMYxRjOEtXlH6ExWeNuDJXtYhfrQAAAABJRU5ErkJggg=="
                                        />
                                    </svg>
                                    <p>8 (3412) 77-60-55, доб. 5160</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </section>
                <section class="contacts" style="margin-top: 100px">
                    <div class="contacts__inner">
                        <p class="contacts__name">Столкнулись с проблемой или ошибкой на сайте?</p>
                        <div class="contacts__form">
                            <div class="contacts__title">Сообщить об ошибке</div>
                            <template v-if="isAuthenticated">
                                <template v-if="!isSubmitted">
                                    <div class="dialog__component">
                                        <p class="dialog__title">Описание проблемы</p>
                                        <textarea
                                            style="background: #FFFFFF"
                                            class="dialog__textarea"
                                            v-model="message"
                                            placeholder="Введите описание"
                                        />
                                    </div>
                                    <div class="contacts__checkbox">
                                        <input
                                            style="-webkit-appearance: auto; width: 20px; height: 20px;"
                                            type="checkbox"
                                            name="privacy"
                                            id="privacy"
                                            v-model="consent"
                                        >
                                        <p>Я соглашаюсь на <a href="#">обработку персональных данных</a></p>
                                    </div>
                                    <div class="dialog__btns">
                                        <button
                                            type="button"
                                            class="main__btn"
                                            style="margin-top: 30px;"
                                            :disabled="isSubmitting"
                                            @click="submitSupportRequest"
                                        >
                                            {{ isSubmitting ? "Отправка..." : "Отправить" }}
                                        </button>
                                    </div>
                                    <p v-if="errorMessage" style="color: #c00; margin-top: 12px;">
                                        {{ errorMessage }}
                                    </p>
                                </template>
                                <template v-else>
                                    <div style="display: flex; align-items: center; gap: 12px; color: #118a37;">
                                        <span style="display: inline-flex; width: 26px; height: 26px;">
                                            <svg viewBox="0 0 24 24" width="26" height="26" aria-hidden="true">
                                                <path
                                                    fill="#118a37"
                                                    d="M12 2a10 10 0 1 0 0 20 10 10 0 0 0 0-20Zm-1.2 14.2-3.4-3.4 1.4-1.4 2 2 4.8-4.8 1.4 1.4-6.2 6.2Z"
                                                />
                                            </svg>
                                        </span>
                                        <p style="margin: 0; font-size: 18px;">Обращение отправлено</p>
                                    </div>
                                </template>
                            </template>
                            <template v-else>
                                <p class="contacts__desc">
                                    Чтобы написать обращение, войдите в аккаунт или зарегистрируйтесь.
                                </p>
                                <div class="dialog__btns" style="margin-top: 20px;">
                                    <a href="/login" class="main__btn">Войти</a>
                                    <a href="/register" class="main__btn main__btn--white" style="margin-left: 12px;">Регистрация</a>
                                </div>
                            </template>
                        </div>
                    </div>
                </section>
            </div>
        </div>
        <div class="b-popup" id="popup">
            <div class="closer-big"></div>
            <div class="b-popup-content">
                <div class="popup-title"></div>
                <div class="popup-desc"></div>
                <div class="form-block">
                    <form
                        method="post"
                        name="mtForm1"
                        id="mtForm1"
                        class="forma"
                    >
                        <input
                            type="hidden"
                            name="data_form"
                            id="data_form"
                            value=""
                        />
                        <input type="hidden" name="no" value="no" />
                        <div class="form-field">
                            <label>
                                <span>Ваше имя:</span>
                                <input
                                    type="text"
                                    name="name"
                                    required="required"
                                />
                            </label>
                        </div>
                        <div class="form-field">
                            <label>
                                <span>Ваш телефон:</span>
                                <input
                                    type="tel"
                                    name="phone"
                                    required="required"
                                    class="phone_valid"
                                />
                            </label>
                        </div>
                        <div class="form-field">
                            <input
                                type="submit"
                                name="submit"
                                value="Отправить заявку"
                            />
                        </div>
                    </form>
                </div>
                <div class="close-up">
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>
        <div class="b-popup" id="message">
            <div class="closer-big closer-big-all"></div>
            <div class="b-popup-content">
                <div class="popup-title">Cпасибо вам!</div>
                <div class="popup-desc">
                    Ваша заявка успешно отправлена. <br />C вами свяжутся в
                    ближайшее время.
                </div>
                <div class="close-up close-up-all">
                    <div></div>
                    <div></div>
                </div>
            </div>
        </div>
    </div>
</template>

<script setup>
import { ref, computed, onMounted } from "vue";
import axios from "axios";

const user = ref(null);
const isAuthenticated = computed(() => Boolean(user.value && user.value.id));
const message = ref("");
const consent = ref(false);
const isSubmitting = ref(false);
const errorMessage = ref("");
const isSubmitted = ref(false);

onMounted(() => {
    const storedUser = localStorage.getItem("user");
    if (!storedUser) return;
    try {
        const parsed = JSON.parse(storedUser);
        if (parsed && parsed.id) {
            user.value = parsed;
        }
    } catch (error) {
        console.error("Ошибка при чтении пользователя из localStorage:", error);
    }
});

const submitSupportRequest = async () => {
    errorMessage.value = "";
    isSubmitted.value = false;

    if (!message.value.trim()) {
        errorMessage.value = "Введите описание проблемы.";
        return;
    }
    if (!consent.value) {
        errorMessage.value = "Нужно согласие на обработку персональных данных.";
        return;
    }
    if (!isAuthenticated.value) {
        errorMessage.value = "Нужно войти в аккаунт.";
        return;
    }

    try {
        isSubmitting.value = true;
        const payload = {
            user_id: user.value.id,
            user_name: user.value.name || user.value.email || "Пользователь",
            message: message.value.trim(),
        };
        await axios.post("/api/support-requests", payload);
        isSubmitted.value = true;
        message.value = "";
        consent.value = false;
    } catch (error) {
        console.error("Ошибка при отправке обращения:", error);
        errorMessage.value =
            error.response?.data?.message || "Ошибка при отправке обращения.";
    } finally {
        isSubmitting.value = false;
    }
};
</script>
